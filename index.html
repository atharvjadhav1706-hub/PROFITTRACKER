<section id="weight-view" class="section hidden">
    <div style="position: sticky; top: 0; z-index: 10;">
        <div class="glass-strong flex-row" style="padding: 8px 16px; display: inline-flex; gap: 12px;">
            <button onclick="switchView('home-view')" class="btn-icon" style="width: 36px; height: 36px; background: rgba(128,128,128,0.1);">
                <svg class="icon" viewBox="0 0 24 24"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
            </button>
            <h1 style="font-size: 16px; font-weight: 900; margin: 0; text-transform: uppercase;">Weight Tracker</h1>
        </div>
    </div>

    <div class="glass" style="padding: 20px;">
        <h3 class="text-xs mb-4">4-Week Progress (Jan 12 Start)</h3>
        <div id="weight-log-list" class="flex-col gap-3"></div>
    </div>
</section>

<script>
/* ---------------- 1. CELEBRATION LOGIC ---------------- */
function vibrateHeavy() {
    if (navigator.vibrate) navigator.vibrate(120);
}

function celebrateGoalOnce() {
    // Check if we already celebrated today to avoid spamming
    if (localStorage.getItem("calorie_goal_done") === todayKey) return;

    vibrateHeavy();
    // Blast from the center of the screen
    triggerBlast(window.innerWidth / 2, window.innerHeight / 3, "green");

    const bar = document.getElementById('calorie-bar');
    bar.style.boxShadow = "0 0 25px rgba(16, 185, 129, 0.9)";
    // Apply pulse animation to the progress bar
    bar.style.animation = "pulseGoal 1.2s infinite";

    localStorage.setItem("calorie_goal_done", todayKey);
}

/* ---------------- 2. UPDATED DASHBOARD ---------------- */
// Replace your existing updateDashboard with this logic
function updateDashboard(skipAnim = false) {
    // ... (keep your existing water count logic) ...

    const plan = mealPlans[dayName] || [];
    const checkedMap = JSON.parse(localStorage.getItem('meal_checked') || '{}');
    let total = 0;
    plan.forEach((m, i) => { if (checkedMap[i]) total += m.c; });

    const calEl = document.getElementById('display-calories');
    const currentCal = parseInt(calEl.innerText) || 0;
    if (!skipAnim && currentCal !== total) animateValue(calEl, currentCal, total, 800); else calEl.innerText = total;

    const cPct = Math.min((total / CALORIE_LIMIT) * 100, 100);
    document.getElementById('calorie-bar').style.width = `${cPct}%`;
    document.getElementById('calorie-percent-text').innerText = `${Math.round(cPct)}%`;

    // TRIGGER: If 100% or more, celebrate!
    if (cPct >= 100) {
        celebrateGoalOnce();
    }
}

/* ---------------- 3. FIXED WEIGHT LOGGING ---------------- */
function renderWeightView() {
    const list = document.getElementById('weight-log-list');
    list.innerHTML = "";
    
    // Unique keys for 4 specific weeks to prevent data overlap
    const weeks = ["Jan 12", "Jan 19", "Jan 26", "Feb 02"];
    const logs = JSON.parse(localStorage.getItem('weight_logs') || '{}');
    
    weeks.forEach((weekLabel, i) => {
        const key = "week_" + i; 
        const val = logs[key] || "";

        list.innerHTML += `
        <div class="list-item flex-row justify-between" style="align-items: center;">
            <div class="flex-col">
                <span style="font-weight:900; font-size:14px;">Week ${i+1}</span>
                <span class="text-xs" style="opacity:0.6">${weekLabel}</span>
            </div>
            <div class="flex-row gap-2" style="align-items:center">
                <input type="number" value="${val}" 
                    placeholder="00.0"
                    onchange="saveWeight('${key}', this.value)"
                    style="width:80px; text-align:right; font-weight:bold; padding:10px; border-radius:12px; background:rgba(128,128,128,0.1); border:none; color:var(--text-main);">
                <span class="text-xs" style="font-weight:800; opacity:0.5;">KG</span>
            </div>
        </div>`;
    });
}

function saveWeight(key, val) {
    const logs = JSON.parse(localStorage.getItem('weight_logs') || '{}');
    logs[key] = val;
    localStorage.setItem('weight_logs', JSON.stringify(logs));
    vibrateLight();
}

/* ---------------- 4. RESET LOGIC (ADD TO INIT) ---------------- */
// Inside your init() or at the top of script:
if (localStorage.getItem("last_date_visited") !== todayKey) {
    localStorage.removeItem("calorie_goal_done");
    localStorage.setItem("last_date_visited", todayKey);
}
</script>
